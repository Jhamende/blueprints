blueprint:
  name: ğŸ”” Alerte tempÃ©rature basse (< 18Â°C)
  description: >
    Envoie une notification quand la tempÃ©rature d'un capteur de type "temperature"
    descend sous un seuil dÃ©fini. Ne se rÃ©pÃ¨te pas tant que la tempÃ©rature n'est pas
    remontÃ©e au-dessus du seuil.
  domain: automation
  input:
    notify_device:
      name: Appareil de notification
      description: L'appareil ou le service qui recevra la notification
      selector:
        device:
          integration: mobile_app
          multiple: false
    seuil:
      name: Seuil de tempÃ©rature
      description: En dessous de cette valeur, la notification est envoyÃ©e
      default: 18
      selector:
        number:
          min: 5
          max: 30
          unit_of_measurement: Â°C
          mode: slider

mode: parallel

trigger:
  - platform: state
    entity_id: all

condition:
  - condition: template
    value_template: >
      {% set s = trigger.to_state %}
      {% set seuil = blueprint.inputs.seuil | float(18) %}
      {{ s is not none
         and s.domain == 'sensor'
         and s.attributes.device_class == 'temperature'
         and (s.state | float(100) < seuil)
         and (trigger.from_state is none or trigger.from_state.state | float(100) >= seuil) }}

action:
  - variables:
      piece: "{{ area_name(trigger.entity_id) or state_attr(trigger.entity_id, 'friendly_name') or trigger.entity_id }}"
      t: "{{ trigger.to_state.state | float(0) }}"
      seuil: "{{ blueprint.inputs.seuil }}"
  - device_id: !input notify_device
    domain: mobile_app
    type: notify
    message: "ğŸ¥¶ {{ piece }} est Ã  {{ '%.1f'|format(t) }}Â°C (sous {{ seuil }}Â°C)."
    title: "Alerte tempÃ©rature"
